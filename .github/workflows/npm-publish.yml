name: Publish to npm

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - develop

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.1.29

      - name: Verify tag matches package version
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: app
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PKG_VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
          if [ "${TAG_VERSION}" != "${PKG_VERSION}" ]; then
            echo "Tag version (${TAG_VERSION}) does not match package.json version (${PKG_VERSION})"
            exit 1
          fi
          echo "Version verified: ${TAG_VERSION}"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: bun-npm-publish-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-npm-publish-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check application
        working-directory: app
        run: bunx tsc --noEmit

      - name: Lint
        working-directory: app
        run: bun run lint

      - name: Install uv (required for ADW MCP tools)
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Run tests
        working-directory: app
        run: bun test --coverage --coverage-reporter=text

      - name: Build
        working-directory: app
        run: bun run build

      - name: Verify package metadata
        working-directory: app
        run: |
          echo "Verifying package.json structure..."
          if ! cat package.json | grep -q '"bin"'; then
            echo "Missing 'bin' field in package.json"
            exit 1
          fi
          if ! cat package.json | grep -q '"files"'; then
            echo "Warning: No 'files' field in package.json (will publish everything)"
          fi
          echo "Package metadata verified"

      - name: Set pre-release version for develop
        if: github.ref == 'refs/heads/develop'
        working-directory: app
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          PRE_VERSION="${CURRENT_VERSION}-next.${TIMESTAMP}"
          echo "Publishing pre-release version: ${PRE_VERSION}"
          node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('package.json'));p.version='${PRE_VERSION}';fs.writeFileSync('package.json',JSON.stringify(p,null,2)+'\n');"

      - name: Publish to npm
        working-directory: app
        run: |
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "Publishing to 'next' tag..."
            bun publish --access public --tag next
          else
            echo "Publishing to 'latest' tag..."
            bun publish --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: app
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          gh release create "${TAG}" \
            --title "Release ${TAG}" \
            --notes "Published to npm: https://www.npmjs.com/package/kotadb/v/${TAG#v}" \
            --verify-tag

      - name: Generate publish summary
        if: always()
        working-directory: app
        run: |
          echo "## npm Publish Summary" >> ${GITHUB_STEP_SUMMARY}
          echo "" >> ${GITHUB_STEP_SUMMARY}
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "**Release Type**: Pre-release (next)" >> ${GITHUB_STEP_SUMMARY}
            echo "**Branch**: develop" >> ${GITHUB_STEP_SUMMARY}
            echo "**Install**: \`npm install kotadb@next\`" >> ${GITHUB_STEP_SUMMARY}
          else
            echo "**Release Type**: Stable (latest)" >> ${GITHUB_STEP_SUMMARY}
            echo "**Tag**: ${{ github.ref_name }}" >> ${GITHUB_STEP_SUMMARY}
            echo "**Install**: \`npm install kotadb\`" >> ${GITHUB_STEP_SUMMARY}
          fi
          echo "**Package**: kotadb" >> ${GITHUB_STEP_SUMMARY}
          echo "**Registry**: https://www.npmjs.com/package/kotadb" >> ${GITHUB_STEP_SUMMARY}
          echo "" >> ${GITHUB_STEP_SUMMARY}
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Successfully published to npm" >> ${GITHUB_STEP_SUMMARY}
          else
            echo "❌ Publish failed - check logs above" >> ${GITHUB_STEP_SUMMARY}
          fi
