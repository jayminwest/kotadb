name: Sync Public Fork

# Automatically sync core codebase to public repository (jayminwest/kotadb)
# Triggers on pushes to develop and main branches
# Removes private components (web/, docs/vision/, production env files)
# Replaces README with public version and adds LICENSE/CONTRIBUTING files

on:
  workflow_dispatch:
  push:
    branches:
      - develop
      - main
    paths:
      - 'app/**'
      - 'automation/**'
      - 'shared/**'
      - '.claude/**'
      - 'docs/**'
      - '!docs/vision/**'
      - 'README.public.md'
      - 'CONTRIBUTING.md'
      - 'LICENSE'
      - '.gitignore'
      - 'package.json'
      - 'biome.json'
      - '.github/workflows/sync-public-fork.yml'

jobs:
  sync:
    name: Sync to Public Repository
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Remove private components
        run: |
          # Remove web application directory (frontend)
          rm -rf web/

          # Remove business strategy and vision docs
          rm -rf docs/vision/

          # Remove production environment files
          rm -f .env.production .env.develop .env.test
          rm -f web/.env.local web/.env.vercel.preview

          echo "Private components removed"

      - name: Replace README with public version
        run: |
          # Replace private README with public-facing version
          mv README.public.md README.md

          echo "README.md replaced with public version"

      - name: Verify public files exist
        run: |
          # Verify LICENSE and CONTRIBUTING.md exist
          if [ ! -f LICENSE ]; then
            echo "ERROR: LICENSE file missing"
            exit 1
          fi

          if [ ! -f CONTRIBUTING.md ]; then
            echo "ERROR: CONTRIBUTING.md file missing"
            exit 1
          fi

          echo "Public documentation files verified"

      - name: Commit public fork changes
        run: |
          # Stage all changes (removals and README replacement)
          git add -A

          # Commit if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_SHA=$(git rev-parse --short HEAD)
            BRANCH_NAME="${{ github.ref_name }}"
            git commit -m "chore: sync from private repo ${BRANCH_NAME} (${COMMIT_SHA})"
          fi

      - name: Push to public fork
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          # Disable any credential helpers to ensure PAT is used
          git config --unset-all http.https://github.com/.extraheader || true
          git config --global credential.helper ""

          # Add public repository as remote with PAT
          git remote add public https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/jayminwest/kotadb.git

          # Force push to public repository (overwrites any direct commits)
          git push public HEAD:${BRANCH_NAME} --force

          echo "Successfully synced to public repository: https://github.com/jayminwest/kotadb/tree/${BRANCH_NAME}"
