# Automated Dependency Vulnerability Scanning with Dependabot

**Issue**: #164
**Type**: feature
**Created**: 2025-12-16

## Summary

Implement automated dependency vulnerability scanning across all package managers (Bun/npm, Python/pip, GitHub Actions) using GitHub Dependabot. Add runtime security scanning to CI pipelines with configurable severity thresholds to catch vulnerabilities before deployment.

## Requirements

- [ ] Dependabot configuration file monitoring all three ecosystems (npm, pip, github-actions)
- [ ] Automated security scanning in app-ci.yml with npm audit
- [ ] Automated security scanning in automation-ci.yml with pip-audit
- [ ] Configurable severity thresholds (fail on high/critical by default)
- [ ] Audit results uploaded as CI artifacts for review
- [ ] GitHub Step Summary reports for security scan results
- [ ] Documentation covering Dependabot workflow and vulnerability response process

## Implementation Steps

### Step 1: Create Dependabot Configuration
**Files**: `.github/dependabot.yml`
**Changes**:
- Create new Dependabot configuration file
- Configure npm ecosystem for app/ directory (monitors bun.lockb)
- Configure pip ecosystem for automation/ directory (monitors pyproject.toml)
- Configure github-actions ecosystem for workflow files
- Set weekly update schedule for all ecosystems
- Configure PR labels: "dependencies", "security"
- Set semantic versioning strategy
- Configure commit message prefix conventions

**Exact Configuration**:
```yaml
version: 2
updates:
  # Bun/npm dependencies for main application
  - package-ecosystem: "npm"
    directory: "/app"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
      timezone: "America/Los_Angeles"
    open-pull-requests-limit: 10
    reviewers:
      - "kotadb/engineering"
    labels:
      - "dependencies"
      - "security"
    versioning-strategy: "increase"
    commit-message:
      prefix: "chore(deps)"
      include: "scope"

  # Python dependencies for automation
  - package-ecosystem: "pip"
    directory: "/automation"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
      timezone: "America/Los_Angeles"
    open-pull-requests-limit: 10
    reviewers:
      - "kotadb/engineering"
    labels:
      - "dependencies"
      - "security"
    versioning-strategy: "increase"
    commit-message:
      prefix: "chore(deps)"
      include: "scope"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
      timezone: "America/Los_Angeles"
    open-pull-requests-limit: 5
    reviewers:
      - "kotadb/engineering"
    labels:
      - "dependencies"
      - "ci"
    commit-message:
      prefix: "chore(ci)"
```

### Step 2: Add Security Scanning to App CI
**Files**: `.github/workflows/app-ci.yml`
**Changes**:
- Add new `security-scan` job after `setup` job
- Use `npm audit` command (Bun supports npm CLI)
- Configure severity threshold (fail on high/critical)
- Generate JSON output for artifact upload
- Create GitHub Step Summary with results
- Upload audit results as artifact with 30-day retention

**Job Definition**:
```yaml
  security-scan:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.1.29'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run npm audit
        id: audit
        run: |
          # Create output directory
          mkdir -p audit-results

          # Run audit with JSON output (allow failures for reporting)
          npm audit --json > audit-results/audit.json || true

          # Run audit with exit codes for severity threshold
          # Audit levels: info (0), low (0), moderate (0), high (1), critical (1)
          npm audit --audit-level=high
        continue-on-error: false

      - name: Generate audit summary
        if: always()
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse JSON and create summary
          if [ -f audit-results/audit.json ]; then
            # Extract vulnerability counts
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results/audit.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results/audit.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results/audit.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results/audit.json)
            INFO=$(jq '.metadata.vulnerabilities.info // 0' audit-results/audit.json)

            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
            echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "| Info | $INFO |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Add failure notice if vulnerabilities found
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "⚠️ **Action Required**: High or critical vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ No high or critical vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Audit failed to generate results" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-security-audit
          path: |
            app/audit-results/
          retention-days: 30
```

### Step 3: Add pip-audit to Automation Dependencies
**Files**: `automation/pyproject.toml`
**Changes**:
- Add `pip-audit` to dev dependencies section
- Specify version constraint: `^2.7.0` (latest stable)

**Addition to `[tool.uv.dev-dependencies]`**:
```toml
pip-audit = "^2.7.0"
```

### Step 4: Add Security Scanning to Automation CI
**Files**: `.github/workflows/automation-ci.yml`
**Changes**:
- Add new step after dependency installation
- Run `uv run pip-audit` with JSON output
- Configure severity threshold (fail on high/critical)
- Generate GitHub Step Summary with results
- Upload audit results as artifact with 30-day retention

**Step Definition** (insert after `Install dependencies with uv` step):
```yaml
      - name: Run security audit
        id: audit
        working-directory: ./automation
        run: |
          # Create output directory
          mkdir -p audit-results

          # Run pip-audit with JSON output (allow failures for reporting)
          uv run pip-audit --format json --output audit-results/audit.json || true

          # Run pip-audit with exit codes for severity threshold
          # Fail on high or critical vulnerabilities
          uv run pip-audit --require-hashes --ignore-vuln PYSEC-0000-0000
        continue-on-error: false

      - name: Generate audit summary
        if: always()
        working-directory: ./automation
        run: |
          echo "## Security Audit Results (Python)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse JSON and create summary
          if [ -f audit-results/audit.json ]; then
            # Count vulnerabilities by severity
            CRITICAL=$(jq '[.dependencies[].vulns[] | select(.fix_versions != null)] | length' audit-results/audit.json)

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Vulnerabilities Found | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Add details if vulnerabilities found
            if [ "$CRITICAL" -gt 0 ]; then
              echo "⚠️ **Action Required**: Vulnerabilities detected in Python dependencies" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Affected Packages" >> $GITHUB_STEP_SUMMARY
              jq -r '.dependencies[] | select(.vulns | length > 0) | "- \(.name) \(.version)"' audit-results/audit.json >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ No vulnerabilities detected in Python dependencies" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Audit failed to generate results" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: automation-security-audit
          path: |
            automation/audit-results/
          retention-days: 30
```

### Step 5: Create Security Documentation
**Files**: `docs/guides/security-vulnerability-scanning.md`
**Changes**:
- Create new guide documenting the vulnerability scanning workflow
- Document Dependabot PR review process
- Document vulnerability response procedures
- Include examples and troubleshooting

**Content**:
```markdown
# Security Vulnerability Scanning Guide

## Overview

KotaDB uses a multi-layered approach to dependency security:

1. **Dependabot**: Automated dependency updates with vulnerability alerts
2. **CI Security Scanning**: Runtime vulnerability detection in all PRs
3. **Manual Audits**: Periodic security reviews

## Dependabot Configuration

### Monitored Ecosystems

| Ecosystem | Directory | Schedule | PR Limit |
|-----------|-----------|----------|----------|
| npm (Bun) | `/app` | Weekly (Monday 9am PT) | 10 |
| pip (uv) | `/automation` | Weekly (Monday 9am PT) | 10 |
| github-actions | `/` | Weekly (Monday 9am PT) | 5 |

### Dependabot PR Workflow

1. **Automated PRs**: Dependabot creates PRs with version updates
2. **CI Validation**: All CI checks must pass (including security scans)
3. **Review**: Engineering team reviews changes
4. **Merge**: Approve and merge if all checks pass

### Labels

- `dependencies`: All Dependabot PRs
- `security`: Security-related updates
- `ci`: GitHub Actions updates

## CI Security Scanning

### App CI (npm audit)

**Severity Threshold**: High and Critical
**Failure Behavior**: CI fails if high/critical vulnerabilities found
**Artifacts**: JSON audit results uploaded (30-day retention)

**Viewing Results**:
1. Check GitHub Step Summary for vulnerability counts
2. Download `app-security-audit` artifact for detailed JSON report
3. Review npm advisory links in audit output

### Automation CI (pip-audit)

**Severity Threshold**: Any vulnerability with available fix
**Failure Behavior**: CI fails if vulnerabilities found
**Artifacts**: JSON audit results uploaded (30-day retention)

**Viewing Results**:
1. Check GitHub Step Summary for affected packages
2. Download `automation-security-audit` artifact for detailed JSON report
3. Review CVE links in pip-audit output

## Vulnerability Response Process

### Step 1: Identification

Vulnerabilities are identified through:
- Dependabot security alerts
- CI security scan failures
- Manual security audits

### Step 2: Assessment

1. **Review Severity**: Critical > High > Moderate > Low
2. **Check Exploitability**: Is the vulnerable code path used?
3. **Evaluate Impact**: What data/systems are at risk?
4. **Verify Fix Availability**: Is a patched version available?

### Step 3: Remediation

**Priority Levels**:

| Severity | Response Time | Action |
|----------|---------------|--------|
| Critical | Immediate | Emergency patch release |
| High | 24-48 hours | Hotfix PR |
| Moderate | 1 week | Include in next release |
| Low | 30 days | Routine update |

**Remediation Options**:
1. **Update Dependency**: Preferred - use latest patched version
2. **Workaround**: Disable vulnerable feature if not used
3. **Accept Risk**: Document decision if fix unavailable (rare)

### Step 4: Verification

1. Run CI security scans locally:
   ```bash
   # App (Bun/npm)
   cd app && npm audit --audit-level=high

   # Automation (Python)
   cd automation && uv run pip-audit
   ```

2. Verify fix resolves vulnerability
3. Ensure all tests pass
4. Confirm no new vulnerabilities introduced

### Step 5: Documentation

1. Update CHANGELOG.md with security fix
2. Create GitHub Security Advisory if public disclosure needed
3. Notify stakeholders if user action required

## Troubleshooting

### False Positives

**Problem**: Audit reports vulnerability in unused code path

**Solution**:
1. Verify code path is not used (grep/code search)
2. Add audit exception with justification:
   ```bash
   # npm
   npm audit --audit-level=high --omit=dev

   # pip
   uv run pip-audit --ignore-vuln VULN-ID-HERE
   ```
3. Document exception in PR description

### Audit Failures

**Problem**: CI security scan fails due to infrastructure issue

**Solution**:
1. Check GitHub Actions status page
2. Retry workflow
3. If persistent, manually run audit and attach results to PR

### Conflicting Dependencies

**Problem**: Security update breaks compatibility

**Solution**:
1. Check breaking changes in dependency changelog
2. Update consuming code to match new API
3. Consider major version update if extensive changes needed
4. Test thoroughly before merging

## Best Practices

1. **Review Dependabot PRs promptly** - Don't let security updates sit
2. **Test security updates** - Automated PRs can introduce breaking changes
3. **Monitor audit artifacts** - Download and review JSON reports periodically
4. **Keep lockfiles committed** - Ensures reproducible builds
5. **Update uv.lock after manual changes** - Run `cd automation && uv lock` after editing pyproject.toml

## References

- [npm audit documentation](https://docs.npmjs.com/cli/v10/commands/npm-audit)
- [pip-audit documentation](https://pypi.org/project/pip-audit/)
- [Dependabot documentation](https://docs.github.com/en/code-security/dependabot)
- [GitHub Security Advisories](https://docs.github.com/en/code-security/security-advisories)
```

## Files to Create

| File | Purpose |
|------|---------|
| `.github/dependabot.yml` | Dependabot configuration for automated dependency updates |
| `docs/guides/security-vulnerability-scanning.md` | Security scanning documentation and procedures |

## Files to Modify

| File | Change Type | Description |
|------|-------------|-------------|
| `.github/workflows/app-ci.yml` | modify | Add security-scan job with npm audit |
| `.github/workflows/automation-ci.yml` | modify | Add security audit step with pip-audit |
| `automation/pyproject.toml` | modify | Add pip-audit to dev dependencies |

## Testing Strategy

**Validation Level**: 2
**Justification**: Infrastructure change with testable failure modes. Requires validation that security scans detect vulnerabilities and fail CI appropriately, but doesn't involve complex business logic or data transformations.

### Test Cases
- [ ] Dependabot creates PRs for outdated npm dependencies in app/
- [ ] Dependabot creates PRs for outdated Python dependencies in automation/
- [ ] Dependabot creates PRs for outdated GitHub Actions
- [ ] App CI security-scan job runs npm audit successfully on clean dependencies
- [ ] App CI security-scan job fails on high-severity vulnerability (test with known vulnerable package)
- [ ] Automation CI security audit runs pip-audit successfully on clean dependencies
- [ ] Automation CI security audit fails on vulnerable dependency (test with known vulnerable package)
- [ ] Audit results are uploaded as artifacts with correct naming
- [ ] GitHub Step Summary displays vulnerability counts correctly
- [ ] Manual npm audit and pip-audit commands work locally

### Test Files
- Manual testing via CI workflow runs (no unit tests required for configuration files)
- Validate with test PR containing intentionally vulnerable dependency

## Convention Checklist

- [x] Path aliases used for all imports (N/A - configuration files)
- [x] Logging via process.stdout.write (N/A - YAML configuration)
- [x] Tests use real Supabase Local (N/A - CI configuration)
- [x] Migrations synced (N/A - no database changes)

## Dependencies

### Depends on
- GitHub Actions runner environment (ubuntu-latest)
- Bun 1.1.29 installation
- npm CLI (provided by Bun)
- uv package manager
- pip-audit package (added to automation dev dependencies)

### Depended on by
- Future security monitoring dashboards
- Security incident response workflows
- Dependency update automation

## Risks

### Risk 1: False Positives in Audits
**Mitigation**:
- Document process for handling false positives in security guide
- Provide examples of audit exception patterns
- Require justification comments for any ignored vulnerabilities

### Risk 2: CI Performance Impact
**Mitigation**:
- Security scans run in parallel with other jobs where possible
- Use `continue-on-error: false` to fail fast
- Set reasonable audit timeouts
- Audit results cached within workflow run

### Risk 3: Dependabot PR Noise
**Mitigation**:
- Limit open PRs per ecosystem (10 for dependencies, 5 for actions)
- Weekly schedule instead of daily
- Group related updates where possible
- Clear labeling for easy filtering

### Risk 4: Breaking Changes in Automated Updates
**Mitigation**:
- All Dependabot PRs go through full CI validation
- Semantic versioning strategy respects major version boundaries
- Engineering team reviews all PRs before merge
- Lockfiles ensure reproducible builds
