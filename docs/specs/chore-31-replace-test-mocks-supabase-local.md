# Chore Plan: Replace Test Mocks with Real Supabase Local Instance (Antimocking)

## Context

The test suite has 31 failing tests (out of 93 total, 33% failure rate) due to authentication middleware requiring real Supabase database connections. The current approach uses mocked Supabase clients, creating a brittle testing architecture that doesn't reflect production behavior.

**Root Cause:** The `validateApiKey()` function in `app/src/auth/validator.ts:115` calls `getServiceClient()` internally, creating a new database connection that cannot be mocked without extensive architecture changes.

**Antimocking Philosophy:** This chore adopts an antimocking approach—remove all service mocks in favor of real service integration testing. Benefits include:
- Elimination of mock maintenance burden
- Production parity testing (connection issues, timeouts, RLS policies)
- True confidence in authentication flow
- No schema/API sync drift between mocks and reality

**Constraints:**
- Must maintain test suite completion time < 30 seconds
- All 93 tests must pass (0 failures)
- CI/CD must run against real Supabase local instance
- Setup must be straightforward for new developers (< 5 minutes)

## Relevant Files

### Files to Modify
- `.github/workflows/ci.yml` — Add Supabase local services to CI pipeline
- `docker-compose.yml` — Add Supabase local development stack (Postgres, Kong, Auth, Storage, Studio)
- `app/package.json` — Add test setup scripts and Supabase CLI integration
- `app/tests/mcp/errors.test.ts` — Remove mock imports, use real auth
- `app/tests/mcp/handshake.test.ts` — Remove mock imports, use real auth
- `app/tests/mcp/tools.test.ts` — Remove mock imports, use real auth
- `app/tests/api/authenticated-routes.test.ts` — Remove mock imports, use real auth
- `app/tests/auth/middleware.test.ts` — Remove mock imports, use real database validation
- `app/tests/auth/validator.test.ts` — Remove mock imports, use real database validation

### Files to Delete
- `app/tests/helpers/supabase-mock.ts` — Mock Supabase client (88 lines)
- `app/tests/helpers/auth-mock.ts` — Mock authentication helpers (96 lines)

### New Files
- `.env.test` — Test environment configuration (auto-generated by setup script)
- `scripts/setup-test-db.sh` — Bash script to start Supabase local, run migrations, seed test data
- `scripts/reset-test-db.sh` — Bash script to reset database state between test runs
- `supabase/seed.sql` — SQL seed script with test users, organizations, API keys, repositories
- `app/tests/helpers/db.ts` — Real database test helpers (e.g., `resetTestDatabase()`, `getTestApiKey()`, `createTestUser()`)
- `docs/testing-setup.md` — Documentation for local test environment setup

## Work Items

### Preparation
1. Back up current test suite results (document current 31 failures)
2. Verify local Docker installation and available ports (5432, 54321, 54323)
3. Review existing Supabase migrations to ensure they run cleanly
4. Create feature branch: `chore/31-replace-test-mocks-supabase-local` from `develop`

### Execution

#### Phase 1: Supabase Local Infrastructure (Docker + Configuration)
1. Add Supabase local services to `docker-compose.yml`:
   - `supabase-db`: PostgreSQL 15 (port 5432)
   - `supabase-kong`: API gateway (port 54321)
   - `supabase-auth`: GoTrue authentication service
   - `supabase-storage`: Storage API
   - `supabase-studio`: Web UI (port 54323)
2. Create `.env.test` template with local Supabase credentials:
   - `SUPABASE_URL=http://localhost:54321`
   - `SUPABASE_SERVICE_KEY=<local-service-key>`
   - `SUPABASE_ANON_KEY=<local-anon-key>`
3. Create `scripts/setup-test-db.sh`:
   - Start Supabase local services via `docker-compose up -d supabase-db supabase-kong supabase-auth`
   - Wait for services to be healthy (health checks)
   - Run migrations via Supabase CLI or direct SQL
   - Run seed script
4. Create `scripts/reset-test-db.sh`:
   - Truncate all test tables (preserving schema)
   - Re-run seed script for clean state

#### Phase 2: Test Data Seeding
1. Create `supabase/seed.sql` with deterministic test data:
   - Test user: `user_id = '00000000-0000-0000-0000-000000000001'`
   - Test organization: `org_id = '00000000-0000-0000-0000-000000000002'`
   - Test API key (free tier): `key_id = 'test1234567890ab'`, `secret_hash = bcrypt('0123456789abcdef0123456789abcdef')`
   - Test API key (solo tier): `key_id = 'solo1234567890ab'`
   - Test API key (team tier): `key_id = 'team1234567890ab'`
   - Test repository: `project_root = 'kotadb/kota-db-ts'`
2. Create `app/tests/helpers/db.ts` with real database helpers:
   - `resetTestDatabase(): Promise<void>` — Truncate + reseed
   - `getTestApiKey(tier?: 'free' | 'solo' | 'team'): Promise<string>` — Fetch real API key from DB
   - `createTestUser(overrides?: Partial<User>): Promise<User>` — Insert test user
   - `createTestOrganization(overrides?: Partial<Organization>): Promise<Organization>` — Insert test org
   - `createTestRepository(overrides?: Partial<Repository>): Promise<Repository>` — Insert test repo
   - `getSupabaseTestClient(): SupabaseClient` — Return configured test client

#### Phase 3: Refactor Test Files
1. Update `app/tests/mcp/errors.test.ts`:
   - Remove `import { createMockSupabaseClient } from "../helpers/supabase-mock"`
   - Remove `import { createMockAuthHeader } from "../helpers/auth-mock"`
   - Add `import { getTestApiKey } from "../helpers/db"`
   - Update `beforeAll`: fetch real API key, set in headers
   - Remove mock Supabase client injection
2. Update `app/tests/mcp/handshake.test.ts`:
   - Same mock removal pattern
   - Use real API key from database
3. Update `app/tests/mcp/tools.test.ts`:
   - Same mock removal pattern
   - Use real API key from database
4. Update `app/tests/api/authenticated-routes.test.ts`:
   - Same mock removal pattern
   - Use real API key from database
5. Update `app/tests/auth/middleware.test.ts`:
   - Remove skip conditions (`[Test] Skipping - Supabase credentials not set`)
   - Use real database validation
6. Update `app/tests/auth/validator.test.ts`:
   - Remove skip conditions
   - Use real database validation

#### Phase 4: CI/CD Integration
1. Update `.github/workflows/ci.yml`:
   - Add PostgreSQL service container (GitHub Actions services)
   - Add step to install Supabase CLI
   - Add step to run `scripts/setup-test-db.sh`
   - Ensure `.env.test` is generated before tests run
   - Run `cd app && bun test` against real Supabase local instance
2. Add CI health checks to verify Supabase services are ready before tests

#### Phase 5: Cleanup & Documentation
1. Delete `app/tests/helpers/supabase-mock.ts`
2. Delete `app/tests/helpers/auth-mock.ts`
3. Create `docs/testing-setup.md`:
   - Prerequisites (Docker, Bun, Supabase CLI)
   - Quick start guide: `./scripts/setup-test-db.sh && bun test`
   - Troubleshooting common issues (port conflicts, service startup)
   - Architecture explanation (why antimocking, what services run locally)
4. Update `README.md` with testing setup instructions (link to `docs/testing-setup.md`)

### Follow-up
1. Run full test suite 10 consecutive times to verify 0 flaky tests
2. Measure test suite execution time (target: < 30 seconds)
3. Verify CI passes on a clean PR
4. Document performance benchmarks in PR description
5. Monitor for any Supabase local startup issues in CI

## Step by Step Tasks

### 1. Preparation & Branch Setup
- Create branch `chore/31-replace-test-mocks-supabase-local` from `develop`
- Document current test suite state (31 failures out of 93 tests)
- Verify Docker is installed and ports 5432, 54321, 54323 are available

### 2. Docker Infrastructure
- Add Supabase local services to `docker-compose.yml` (postgres, kong, auth, storage, studio)
- Create `.env.test` with local Supabase connection details
- Test manual startup: `docker-compose up -d supabase-db supabase-kong`

### 3. Setup Scripts
- Create `scripts/setup-test-db.sh` (start services, run migrations, seed data)
- Create `scripts/reset-test-db.sh` (truncate tables, re-seed)
- Make scripts executable: `chmod +x scripts/*.sh`
- Test scripts manually to ensure they work

### 4. Test Data Seeding
- Create `supabase/seed.sql` with deterministic test data (users, orgs, API keys, repos)
- Generate real bcrypt hashes for test API keys
- Verify seed script runs without errors: `./scripts/setup-test-db.sh`

### 5. Database Test Helpers
- Create `app/tests/helpers/db.ts` with real database helper functions
- Implement `resetTestDatabase()`, `getTestApiKey()`, `createTestUser()`, etc.
- Export `getSupabaseTestClient()` for test files to use

### 6. Refactor MCP Tests
- Update `app/tests/mcp/errors.test.ts`: remove mocks, use `getTestApiKey()`
- Update `app/tests/mcp/handshake.test.ts`: remove mocks, use `getTestApiKey()`
- Update `app/tests/mcp/tools.test.ts`: remove mocks, use `getTestApiKey()`
- Run `cd app && bun test app/tests/mcp/` to verify MCP tests pass

### 7. Refactor API Tests
- Update `app/tests/api/authenticated-routes.test.ts`: remove mocks, use `getTestApiKey()`
- Run `cd app && bun test app/tests/api/` to verify API tests pass

### 8. Refactor Auth Tests
- Update `app/tests/auth/middleware.test.ts`: remove skip conditions, use real validation
- Update `app/tests/auth/validator.test.ts`: remove skip conditions, use real validation
- Run `cd app && bun test app/tests/auth/` to verify auth tests pass

### 9. Full Test Suite Validation
- Run `cd app && bun test` to execute all 93 tests
- Verify 0 failures (100% pass rate)
- Measure execution time (must be < 30 seconds)

### 10. CI/CD Integration
- Update `.github/workflows/ci.yml` with Supabase local services
- Add Supabase CLI installation step
- Add test database setup step
- Push branch and verify CI passes

### 11. Cleanup Mock Files
- Delete `app/tests/helpers/supabase-mock.ts`
- Delete `app/tests/helpers/auth-mock.ts`
- Verify no remaining imports: `git grep "supabase-mock\|auth-mock"`

### 12. Documentation
- Create `docs/testing-setup.md` with local test environment guide
- Update `README.md` to link to testing documentation
- Update `.claude/commands/conditional_docs.md` with testing-setup.md conditions

### 13. Validation & Push
- Run `cd app && bun run lint` (must pass)
- Run `cd app && bunx tsc --noEmit` (must pass)
- Run `cd app && bun test` 10 consecutive times (must pass all runs, 0 flaky tests)
- Run `cd app && bun run build` (must pass)
- Commit all changes: `git add . && git commit -m "chore: replace test mocks with real Supabase local instance (#31)"`
- Push branch: `git push -u origin chore/31-replace-test-mocks-supabase-local`

### 14. Create Pull Request
- Run `/pull_request chore/31-replace-test-mocks-supabase-local {"number":31,"title":"chore: replace test mocks with real Supabase local instance (antimocking)"} docs/specs/chore-31-replace-test-mocks-supabase-local.md <adw_id>`

## Risks

| Risk | Mitigation |
|------|------------|
| **Slow test execution** | Use database transactions + rollback for cleanup (faster than truncate/seed); benchmark and optimize query patterns |
| **Flaky tests from shared state** | Implement proper cleanup hooks in `afterEach`; ensure deterministic seed data; consider test isolation strategies |
| **CI environment differences** | Use identical Docker images for local and CI; document exact versions; use health checks before running tests |
| **Supabase local startup time** | Cache Docker images in CI; use health checks with retries; start services in background during dependency install |
| **Port conflicts in local dev** | Document port requirements in setup guide; provide alternative port configuration via env vars |
| **Increased setup complexity** | Provide automated setup script; clear error messages; comprehensive troubleshooting guide |
| **Mock removal breaking existing tests** | Refactor tests incrementally; run test suite after each file update; keep track of pass/fail rate |
| **Database state pollution between tests** | Implement robust `resetTestDatabase()` function; use transactions where possible; truncate tables in proper order (respecting foreign keys) |

## Validation Commands

### Required Validation
```bash
# Type checking
cd app && bunx tsc --noEmit

# Linting
cd app && bun run lint

# Full test suite (must pass all 93 tests)
cd app && bun test

# Build validation
cd app && bun run build
```

### Additional Validation
```bash
# Verify no mock imports remain
git grep "createMockSupabaseClient\|createMockAuthHeader"
# Expected: no results

# Verify Supabase services are running
docker-compose ps | grep supabase
# Expected: all services "Up" and healthy

# Run tests 10 times to check for flakiness
for i in {1..10}; do echo "Run $i"; cd app && bun test || break; done
# Expected: all runs pass

# Measure test execution time
time cd app && bun test
# Expected: < 30 seconds

# Verify test database is seeded
psql -h localhost -U postgres -d postgres -c "SELECT COUNT(*) FROM api_keys;"
# Expected: >= 3 (free, solo, team test keys)
```

## Deliverables

### Code Changes
- Supabase local services added to `docker-compose.yml`
- Test setup and reset scripts (`scripts/setup-test-db.sh`, `scripts/reset-test-db.sh`)
- Real database test helpers (`app/tests/helpers/db.ts`)
- All test files refactored to use real Supabase client (9 test files)
- Mock helpers deleted (`app/tests/helpers/supabase-mock.ts`, `app/tests/helpers/auth-mock.ts`)

### Config Updates
- `.env.test` with local Supabase credentials
- `.github/workflows/ci.yml` with Supabase local services
- `app/package.json` with test setup scripts (if needed)

### Documentation Updates
- `docs/testing-setup.md` — Comprehensive testing environment guide
- `README.md` — Updated with testing setup instructions
- `.claude/commands/conditional_docs.md` — Added conditions for `docs/testing-setup.md`

### Validation Evidence
- Test suite results: 93 pass, 0 fail (100% pass rate)
- Test execution time: < 30 seconds
- CI pipeline passing with real Supabase local instance
- 10 consecutive test runs with 0 flaky tests
- No remaining mock imports in codebase
