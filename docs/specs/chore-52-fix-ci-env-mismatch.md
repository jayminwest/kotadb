# Chore Plan: Fix CI Environment Variable Mismatch

## Context
CI tests are failing with 401 authentication errors because tests are using hardcoded environment variables (SUPABASE_URL=http://localhost:54322) that don't match the dynamic container ports generated by Docker Compose in GitHub Actions. The .env.test file is correctly generated with dynamic ports (e.g., http://localhost:55066), but tests that set environment variables at module-level are not loading from .env.test and are using stale hardcoded values instead.

**Why this chore matters now:**
- All authenticated endpoint tests are failing in CI (10 failing tests)
- Tests pass locally because hardcoded ports happen to match local Supabase stack
- PR #51 cannot be merged until CI is green
- This blocks deployment of containerized test environment improvements

**Constraints:**
- Must maintain antimocking compliance (no mocks, real database testing only)
- Cannot change Docker Compose dynamic port allocation strategy (required for CI isolation)
- Must preserve test isolation and parallel execution capabilities

## Relevant Files
- `app/tests/mcp/handshake.test.ts` — Sets hardcoded env vars at module-level (lines 2-8), preventing .env.test loading
- `app/tests/api/authenticated-routes.test.ts` — Likely has similar hardcoded env var issue
- `app/tests/helpers/db.ts` — Defines test constants with hardcoded ports (line 18: http://localhost:54322)
- `.github/workflows/ci.yml` — Sources .env.test but tests override it (line 45)
- `.env.test` — Correctly generated with dynamic ports but not respected by tests

### New Files
None (fixing existing configuration only)

## Work Items

### Preparation
1. Review all test files for hardcoded environment variable assignments
2. Identify pattern for loading .env.test before module-level imports
3. Document the root cause for future reference

### Execution
1. Remove hardcoded `process.env` assignments from test files (app/tests/mcp/handshake.test.ts, app/tests/api/authenticated-routes.test.ts)
2. Update app/tests/helpers/db.ts to read from environment variables instead of hardcoded constants
3. Ensure test files import environment-dependent modules after .env.test is loaded via CI workflow's export command
4. Add validation script to detect hardcoded localhost URLs in test files
5. Run full test suite locally to verify fixes
6. Push changes and monitor CI run

### Follow-up
1. Monitor GitHub Actions CI run for successful completion
2. Document environment variable loading strategy in CLAUDE.md
3. Add pre-commit check to prevent hardcoded environment URLs in tests

## Step by Step Tasks

### Phase 1: Identify All Hardcoded Environment Variables
- Search test directory for hardcoded `process.env.SUPABASE_URL` assignments
- Search test directory for hardcoded `process.env.DATABASE_URL` assignments
- Search test directory for hardcoded localhost:54322 references
- Search test helpers for hardcoded connection constants

### Phase 2: Fix Environment Variable Loading
- Remove hardcoded env var assignments from app/tests/mcp/handshake.test.ts (lines 2-8)
- Remove hardcoded env var assignments from app/tests/api/authenticated-routes.test.ts (if present)
- Update app/tests/helpers/db.ts to read TEST_DB_URL and TEST_DB_KEY from environment variables with fallback
- Ensure all test files can load environment variables from CI's export command (already done in ci.yml:45)
- Verify that beforeAll hooks can access environment variables set by shell

### Phase 3: Add Safeguards
- Create validation script to grep for hardcoded localhost URLs in test files
- Add npm/bun script entry for environment validation
- Document environment variable loading pattern in tests

### Phase 4: Validation and Deployment
- Run `cd app && bun test` locally to verify all tests pass
- Run `cd app && bunx tsc --noEmit` to ensure type safety
- Run `cd app && bun run lint` to check code style
- Commit changes with descriptive message
- Push branch to origin with `git push -u origin chore/51-containerize-test-environment-docker-compose`
- Monitor CI run and verify all tests pass
- Run `/pull_request chore/51-containerize-test-environment-docker-compose {} /Users/jayminwest/Projects/kota-db-ts/docs/specs/chore-52-fix-ci-env-mismatch.md adw-chore-52` to create PR

## Risks

**Risk:** Tests may still fail if environment variables aren't exported correctly in CI workflow
**Mitigation:** The CI workflow already exports .env.test variables (line 45: `export $(grep -v '^#' .env.test | xargs)`), so removing hardcoded values should allow this to work

**Risk:** Local tests may break if developers don't have .env.test generated
**Mitigation:** Update test helpers to fall back to standard Supabase Local ports (54322, 5434) when env vars are not set, preserving local development experience

**Risk:** Dynamic environment variable loading may introduce timing issues
**Mitigation:** Environment variables are set by shell before `cd app && bun test` runs, so they will be available at module load time

## Validation Commands
- `cd app && bun run lint` — Ensure code style compliance
- `cd app && bunx tsc --noEmit` — Type-check without emitting files
- `cd app && bun test` — Run full test suite (133 tests)
- `cd app && bun run test:validate-migrations` — Ensure migration sync
- `grep -r "localhost:54322" app/tests/` — Verify no hardcoded URLs remain
- `grep -r "localhost:5434" app/tests/` — Verify no hardcoded database ports remain

## Deliverables
- Fixed test files that respect dynamic environment variables from .env.test
- Updated test helper to read from environment variables with sensible fallbacks
- Validation script to prevent future hardcoded environment URLs
- Green CI pipeline with all 133 tests passing
- Documentation update in CLAUDE.md explaining environment variable loading strategy
