# Feature Plan: Supabase Local Testing Environment with .env.test Auto-Generation

## Overview

### Problem
KotaDB testing infrastructure has been migrated from SQLite to Supabase Local (issues #31, #33), but lacks the polish and automation described in issue #28. Current gaps:
- `.env.test` is manually maintained (not auto-generated from `supabase status`)
- Test setup uses Docker Compose directly instead of Supabase CLI
- Missing convenience npm/package.json scripts for test lifecycle
- Documentation exists but doesn't cover the vision from #28 (auto-generation workflow)
- No Supabase CLI integration pattern for developers

The existing infrastructure works excellently (94 passing tests, 11.2s execution time), but developer experience could be improved with automation.

### Desired Outcome
Enhance the existing test infrastructure to match the original vision from issue #28:
1. **Auto-generated `.env.test`**: Script extracts credentials from `supabase status` JSON output and generates test environment file
2. **Supabase CLI workflow**: Use `supabase start/stop/status` commands instead of raw Docker Compose
3. **Package.json scripts**: Add `test:setup`, `test:teardown`, `test:reset` for simplified workflows
4. **Enhanced documentation**: Update `docs/testing-setup.md` with CLI-first approach and auto-generation benefits
5. **Developer UX polish**: One-command setup (`bun run test:setup`) with clear output and error messages

### Non-goals
- Replace existing Docker Compose infrastructure (keep as backup/advanced option)
- Change test data or schema structure (current seed data works perfectly)
- Modify test files (already refactored in #31/#33, 94 tests passing)
- CI/CD changes (current GitHub Actions workflow is stable)

## Technical Approach

### Architecture Notes
**Current State (Issues #31/#33):**
- Docker Compose services: `supabase-db`, `supabase-rest`, `supabase-auth`, `supabase-kong`
- Custom ports: PostgreSQL 5434, PostgREST 54322, Kong 54326, Studio 54328
- Static `.env.test` file with hardcoded credentials
- Manual `./scripts/setup-test-db.sh` script using Docker Compose
- 94 passing tests in 11.2 seconds

**Target State (Issue #28 Enhancement):**
- Add Supabase CLI integration layer (runs `supabase start` which manages Docker underneath)
- Auto-generate `.env.test` from `supabase status --output json`
- Add package.json scripts for developer convenience
- Keep Docker Compose as fallback for advanced users
- Maintain all existing test data and structure

### Key Modules to Touch
- `scripts/setup-test-db.sh` — Enhance with Supabase CLI + auto-generation logic
- `scripts/generate-env-test.sh` — **NEW**: Extract credentials from `supabase status --output json`
- `package.json` — Add `test:setup`, `test:teardown`, `test:reset`, `test:env` scripts
- `supabase/config.toml` — **NEW**: Supabase CLI project configuration (if not exists)
- `docs/testing-setup.md` — Update with CLI-first workflow and auto-generation guide
- `.gitignore` — Ensure `.env.test` remains gitignored

### Data/API Impacts
**None.** This is a developer experience enhancement. All existing test data, schema, and test files remain unchanged.

## Relevant Files

### Files to Modify
- `scripts/setup-test-db.sh` — Add Supabase CLI integration, call `generate-env-test.sh`
- `scripts/reset-test-db.sh` — Add Supabase CLI commands (`supabase db reset`)
- `package.json` — Add test lifecycle scripts (test:setup, test:teardown, test:reset, test:env)
- `docs/testing-setup.md` — Update with Supabase CLI workflow and auto-generation instructions
- `.claude/commands/conditional_docs.md` — Update conditions for testing-setup.md (already exists)

### New Files
- `scripts/generate-env-test.sh` — Bash script to auto-generate `.env.test` from `supabase status --output json`
- `supabase/config.toml` — Supabase CLI project configuration (if not already present)
- `docs/specs/feature-28-supabase-local-env-test.md` — This plan document

### Unchanged Files (Already Implemented)
- `.env.test` — Will be regenerated by script, but structure stays the same
- `supabase/seed.sql` — Test data perfect as-is (users, API keys, repositories)
- `supabase/kong.yml` — Kong gateway configuration working correctly
- `tests/**/*.test.ts` — All 94 tests passing, no changes needed
- `src/db/migrations/*` — Schema migrations unchanged
- `.github/workflows/ci.yml` — CI pipeline stable, no changes needed

## Task Breakdown

### Phase 1: Supabase CLI Integration
**Goal:** Add Supabase CLI commands as primary interface, keep Docker Compose as implementation detail

Tasks:
- Verify Supabase CLI installed: `supabase --version` (document requirement in README)
- Create `supabase/config.toml` if not exists (initialize with `supabase init`)
- Configure custom ports in `config.toml` to match existing Docker setup (5434, 54322, 54326, 54328)
- Update `scripts/setup-test-db.sh` to use `supabase start` instead of `docker compose up`
- Update `scripts/reset-test-db.sh` to use `supabase db reset --no-seed` + manual seed
- Test that `supabase start` brings up same services as current Docker Compose approach

### Phase 2: Auto-Generation Script
**Goal:** Create `generate-env-test.sh` to extract credentials from Supabase CLI

Tasks:
- Create `scripts/generate-env-test.sh` with:
  - Run `supabase status --output json` and parse JSON
  - Extract: `API_URL`, `ANON_KEY`, `SERVICE_ROLE_KEY`, `DB_URL`
  - Generate `.env.test` with correct format (match existing structure)
  - Handle errors gracefully (Supabase not running, jq not installed)
- Add dependency check for `jq` (JSON parsing utility)
- Make script executable: `chmod +x scripts/generate-env-test.sh`
- Update `scripts/setup-test-db.sh` to call `generate-env-test.sh` after `supabase start`
- Test manual execution: `./scripts/generate-env-test.sh`
- Verify generated `.env.test` matches expected format

### Phase 3: Package.json Scripts
**Goal:** Add convenience scripts for common test workflows

Tasks:
- Add `"test:setup": "./scripts/setup-test-db.sh"` to package.json
- Add `"test:teardown": "supabase stop"` to package.json
- Add `"test:reset": "./scripts/reset-test-db.sh"` to package.json
- Add `"test:env": "./scripts/generate-env-test.sh"` to package.json
- Add `"test:status": "supabase status"` to package.json
- Test all new scripts: `bun run test:setup`, `bun run test:env`, etc.
- Document scripts in `docs/testing-setup.md`

### Phase 4: Documentation Updates
**Goal:** Update testing guide with CLI-first approach and auto-generation workflow

Tasks:
- Update `docs/testing-setup.md`:
  - Add "Prerequisites" section with Supabase CLI installation (`brew install supabase/tap/supabase`)
  - Add "Quick Start" section featuring `bun run test:setup` (instead of raw script)
  - Document auto-generation workflow (how `generate-env-test.sh` works)
  - Add troubleshooting section for Supabase CLI issues
  - Document fallback to Docker Compose for advanced users
- Update `README.md` "Running Tests" section:
  - Replace `./scripts/setup-test-db.sh` with `bun run test:setup`
  - Add note about auto-generated `.env.test`
- Add comments to `scripts/generate-env-test.sh` explaining JSON parsing logic

### Phase 5: Polish & Error Handling
**Goal:** Improve developer experience with clear messages and error handling

Tasks:
- Add dependency checks to `scripts/setup-test-db.sh`:
  - Check `supabase` CLI installed
  - Check `jq` installed
  - Check Docker running
  - Provide installation instructions if missing
- Add status output to scripts:
  - Show which services are starting
  - Display test API keys after setup
  - Show Supabase Studio URL (http://localhost:54328)
- Add error handling:
  - Port conflicts (5434, 54322, 54326 already in use)
  - Supabase startup failures
  - Migration errors
- Test error scenarios manually

## Step by Step Tasks

### 1. Verify Current State & Prerequisites
- Verify all 94 tests currently passing: `bun test`
- Check Supabase CLI installed: `supabase --version` (install if missing: `brew install supabase/tap/supabase`)
- Check `jq` installed: `jq --version` (install if missing: `brew install jq`)
- Document current test execution time baseline (~11 seconds)
- Create feature branch: `git checkout -b feat/28-supabase-local-env-test` (branching from `develop`)

### 2. Initialize Supabase CLI Project
- Run `supabase init` in project root (if `supabase/config.toml` doesn't exist)
- Configure custom ports in `supabase/config.toml`:
  - `db.port = 5434` (PostgreSQL)
  - `api.port = 54322` (PostgREST)
  - `auth.port = 54324` (GoTrue)
  - `studio.port = 54328` (Studio UI)
- Link migrations: ensure `supabase/migrations/` contains our migrations or symlink `src/db/migrations/`
- Test `supabase start` brings up services correctly
- Test `supabase status` shows running services
- Stop services: `supabase stop`

### 3. Create Auto-Generation Script
- Create `scripts/generate-env-test.sh` with:
  - Shebang and error handling (`set -euo pipefail`)
  - Check Supabase running: `supabase status --output json`
  - Parse JSON with `jq` to extract credentials
  - Generate `.env.test` with correct format
  - Add clear output messages
- Make executable: `chmod +x scripts/generate-env-test.sh`
- Test manual execution: `./scripts/generate-env-test.sh`
- Verify generated `.env.test` has correct structure (compare with existing file)

### 4. Update Setup Script
- Modify `scripts/setup-test-db.sh`:
  - Replace `docker compose up -d` with `supabase start`
  - Wait for services using `supabase status` instead of raw PostgreSQL checks
  - Call `./scripts/generate-env-test.sh` after services start
  - Keep migration and seed logic unchanged (working perfectly)
  - Add clear output showing test API keys and Studio URL
- Test updated script: `./scripts/setup-test-db.sh`
- Verify `.env.test` auto-generated correctly
- Run tests to ensure nothing broken: `bun test`

### 5. Update Reset Script
- Modify `scripts/reset-test-db.sh`:
  - Use `supabase db reset --no-seed` instead of manual truncation
  - Re-run `supabase/seed.sql` manually after reset
  - Keep working logic as-is (just wrap with Supabase CLI)
- Test reset script: `bun run test:reset && bun test`
- Verify tests still pass after reset

### 6. Add Package.json Scripts
- Edit `package.json` to add test scripts:
  ```json
  "scripts": {
    "test:setup": "./scripts/setup-test-db.sh",
    "test:teardown": "supabase stop",
    "test:reset": "./scripts/reset-test-db.sh",
    "test:env": "./scripts/generate-env-test.sh",
    "test:status": "supabase status"
  }
  ```
- Test each script:
  - `bun run test:setup` → Should start Supabase and generate `.env.test`
  - `bun run test:status` → Should show running services
  - `bun run test:reset` → Should reset database
  - `bun run test:teardown` → Should stop services
  - `bun run test:env` → Should regenerate `.env.test`

### 7. Update Documentation
- Update `docs/testing-setup.md`:
  - Add "Prerequisites" section (Supabase CLI, jq, Docker)
  - Replace "Quick Start" with `bun run test:setup` workflow
  - Add "Auto-Generated .env.test" section explaining the script
  - Add troubleshooting section for CLI issues
  - Document new package.json scripts
  - Keep existing content about test data, RLS, etc.
- Update `README.md` "Running Tests" section:
  - Change first-time setup to `bun run test:setup`
  - Mention auto-generated `.env.test`
  - Keep link to detailed guide

### 8. Add Error Handling & Polish
- Update `scripts/setup-test-db.sh` with dependency checks:
  - Check `supabase` command exists (provide install instructions if missing)
  - Check `jq` command exists (provide install instructions if missing)
  - Check Docker running: `docker info > /dev/null 2>&1`
- Update `scripts/generate-env-test.sh` with error handling:
  - Handle case where Supabase not running (show helpful error)
  - Handle case where `jq` not installed
  - Validate JSON parsing succeeded
- Add helpful output messages showing what's happening at each step

### 9. Testing & Validation
- Full integration test sequence:
  - Stop any running Supabase: `bun run test:teardown`
  - Fresh setup: `bun run test:setup`
  - Verify `.env.test` generated correctly
  - Run full test suite: `bun test` (expect 94 passing)
  - Reset database: `bun run test:reset`
  - Run tests again: `bun test` (expect 94 passing)
  - Check status: `bun run test:status`
  - Teardown: `bun run test:teardown`
- Measure test execution time (should remain ~11 seconds)
- Test error scenarios:
  - Run `bun run test:setup` with Docker stopped (should show clear error)
  - Run `bun run test:env` with Supabase stopped (should show helpful message)

### 10. Validation Commands
- Run type checking: `bunx tsc --noEmit` (must pass)
- Run linting: `bun run lint` (must pass)
- Run full test suite: `bun test` (must pass, 94 tests)
- Run build: `bun run build` (must pass)
- Verify no hardcoded credentials in scripts: `git grep -E "eyJhbGc|postgres@localhost" scripts/`
- Verify `.env.test` in `.gitignore`: `cat .gitignore | grep "\.env\.test"`

### 11. Commit & Push
- Stage changes: `git add scripts/ package.json docs/ supabase/ .gitignore`
- Commit with descriptive message: `git commit -m "feat: add Supabase CLI integration and auto-generated .env.test (#28)"`
- Push branch: `git push -u origin feat/28-supabase-local-env-test`

### 12. Create Pull Request
- Run `/pull_request feat/28-supabase-local-env-test {"number":28,"title":"feat: implement Supabase local testing environment with .env.test auto-generation"} docs/specs/feature-28-supabase-local-env-test.md <adw_id>`

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| **Supabase CLI breaks existing Docker workflow** | Keep Docker Compose as fallback; Supabase CLI uses Docker underneath, so services remain compatible |
| **Auto-generation script fails on different environments** | Add robust error handling; provide manual `.env.test` template as fallback; test on macOS/Linux |
| **Port conflicts with existing Supabase instances** | Document custom ports (5434, 54322, 54326, 54328); add port conflict detection in setup script |
| **`jq` not installed on developer machines** | Add dependency check in setup script; provide clear installation instructions (`brew install jq`) |
| **Supabase CLI version compatibility** | Document required CLI version (1.x+); add version check in setup script |
| **CI pipeline breaks** | No CI changes planned; test locally before pushing; existing CI workflow remains unchanged |
| **Developer confusion between CLI and Docker Compose** | Clear documentation explaining relationship; CLI is primary interface, Docker is implementation detail |
| **Test execution time increases** | Benchmark before/after; Supabase CLI uses same Docker containers, so no performance impact expected |

## Validation Strategy

### Automated Tests
**No new tests required.** All 94 existing tests must continue passing. This is purely a developer tooling enhancement.

Test validation sequence:
1. `bun run test:setup` — Setup test environment
2. `bun test` — Run all 94 tests (must pass)
3. `bun run test:reset` — Reset database
4. `bun test` — Run tests again (must pass)
5. `bun run test:teardown` — Clean up

### Manual Checks
1. **Fresh setup workflow:**
   - Clone repository (simulate new developer)
   - Install dependencies: `bun install`
   - Setup tests: `bun run test:setup`
   - Verify `.env.test` auto-generated
   - Run tests: `bun test`
   - Expected: All 94 tests pass

2. **Supabase CLI integration:**
   - Run `supabase status` — Should show running services
   - Open Studio UI: http://localhost:54328 — Should display test data
   - Query test database: `psql -h localhost -p 5434 -U postgres -d postgres -c "SELECT COUNT(*) FROM api_keys;"`
   - Expected: 4 API keys (free, solo, team, disabled)

3. **Error handling:**
   - Stop Docker
   - Run `bun run test:setup`
   - Expected: Clear error message about Docker not running (not cryptic stack trace)

4. **Auto-generation:**
   - Delete `.env.test`
   - Run `bun run test:env`
   - Verify `.env.test` recreated with correct credentials
   - Run `bun test` — Should still pass

### Release Guardrails
- Document minimum required versions (Supabase CLI 1.x+, jq 1.6+, Docker 20+)
- Provide fallback documentation for manual `.env.test` creation
- Keep existing Docker Compose files as backup option
- No breaking changes to test files or CI pipeline

## Validation Commands

### Level 2 Validation (Required)
```bash
# Type checking
bunx tsc --noEmit

# Linting
bun run lint

# Full test suite (94 tests must pass)
bun test

# Build validation
bun run build
```

### Domain-Specific Validation
```bash
# Test setup workflow
bun run test:setup
# Expected: Supabase starts, .env.test generated, migrations run, data seeded

# Verify auto-generated .env.test structure
cat .env.test | grep -E "SUPABASE_URL|SUPABASE_SERVICE_KEY|SUPABASE_ANON_KEY|DATABASE_URL"
# Expected: All 4 environment variables present

# Test reset workflow
bun run test:reset
bun test
# Expected: 94 tests pass after reset

# Test teardown workflow
bun run test:teardown
docker ps | grep supabase
# Expected: No supabase containers running

# Verify Supabase CLI integration
supabase status --output json | jq '.services[] | select(.name == "db")'
# Expected: PostgreSQL service details (after test:setup)

# Verify no hardcoded secrets in scripts
git grep -E "eyJhbGc|test-service-key|test-anon-key" scripts/
# Expected: No results (credentials should come from Supabase status)

# Test execution time (should remain fast)
time bun test
# Expected: ~11 seconds (within 20% of current baseline)

# Verify test data seeded correctly
PGPASSWORD=postgres psql -h localhost -p 5434 -U postgres -d postgres -c "SELECT key_id, tier, enabled FROM api_keys ORDER BY tier;"
# Expected: 4 rows (test1234567890ab, solo1234567890ab, team1234567890ab, disabled12345678)
```

## Report Summary

### Plan Summary
This feature plan enhances KotaDB's existing test infrastructure (completed in #31/#33) by adding:
1. **Auto-generated `.env.test`** — Script extracts credentials from `supabase status --output json`, eliminating manual configuration
2. **Supabase CLI integration** — Developer-friendly commands (`bun run test:setup/reset/teardown`) replacing raw Docker Compose
3. **Improved documentation** — Updated `docs/testing-setup.md` with CLI-first workflow and troubleshooting guide

All 94 existing tests remain unchanged. This is a pure developer experience enhancement with zero functional impact.

### Plan Location
`docs/specs/feature-28-supabase-local-env-test.md`
