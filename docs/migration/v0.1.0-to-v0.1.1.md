# Migration Guide: v0.1.0 to v0.1.1

## Overview

Version 0.1.1 introduces stricter Accept header validation for the MCP endpoint. The MCP SDK's `StreamableHTTPServerTransport` requires clients to explicitly accept both JSON and Server-Sent Events (SSE) responses.

**Impact**: Existing `.mcp.json` configurations that don't specify the correct Accept header will receive HTTP 406 "Not Acceptable" errors.

**Effort**: 2-5 minutes to update configuration files.

## Breaking Change: Accept Header Requirement

### What Changed

The MCP endpoint (`POST /mcp`) now requires the Accept header to include **both**:
- `application/json`
- `text/event-stream`

This is enforced by the MCP SDK's `StreamableHTTPServerTransport`, even when using JSON-only mode (`enableJsonResponse: true`).

**Why This Matters:**
- Ensures protocol compatibility with MCP SDK
- Enables future streaming capabilities
- Aligns with MCP specification requirements

### Before (v0.1.0)

This configuration worked in v0.1.0 but **fails in v0.1.1+**:

```json
{
  "mcpServers": {
    "kotadb": {
      "type": "http",
      "url": "https://kotadb.fly.dev/mcp",
      "headers": {
        "Authorization": "Bearer YOUR_API_KEY"
      }
    }
  }
}
```

### After (v0.1.1)

Update your `.mcp.json` to include the required Accept header:

```json
{
  "mcpServers": {
    "kotadb": {
      "type": "http",
      "url": "https://kotadb.fly.dev/mcp",
      "headers": {
        "Authorization": "Bearer YOUR_API_KEY",
        "Accept": "application/json, text/event-stream",
        "MCP-Protocol-Version": "2025-06-18"
      }
    }
  }
}
```

## Migration Steps

### 1. Locate Your Configuration File

Find your `.mcp.json` file:

```bash
# Project-level (most common)
ls -la .mcp.json

# Or check Claude Code settings
# macOS: ~/Library/Application Support/Claude/
# Linux: ~/.config/Claude/
# Windows: %APPDATA%\Claude\
```

### 2. Update Headers

Add the Accept header to each KotaDB MCP server configuration:

```json
{
  "headers": {
    "Authorization": "Bearer YOUR_API_KEY",
    "Accept": "application/json, text/event-stream",
    "MCP-Protocol-Version": "2025-06-18"
  }
}
```

### 3. Restart Claude Code

For changes to take effect:
1. Close all Claude Code sessions
2. Restart your terminal
3. Re-open Claude Code

### 4. Verify Connection

Test that MCP tools are available:

```bash
# In Claude Code, ask:
"List the available MCP tools from kotadb"

# Expected: search_code, index_repository, list_recent_files, etc.
```

## Verification Commands

### Test with Correct Headers (Should Succeed)

```bash
curl -X POST https://kotadb.fly.dev/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -H "MCP-Protocol-Version: 2025-06-18" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list",
    "params": {}
  }'
```

**Expected**: HTTP 200 with list of available tools

### Test with Incorrect Headers (Should Fail)

```bash
curl -X POST https://kotadb.fly.dev/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list",
    "params": {}
  }'
```

**Expected**: HTTP 406 "Not Acceptable: Client must accept both application/json and text/event-stream"

## Troubleshooting

### HTTP 406 Not Acceptable

**Error**: `Not Acceptable: Client must accept both application/json and text/event-stream`

**Causes**:
1. Missing Accept header entirely
2. Accept header only includes `application/json` (missing `text/event-stream`)
3. Configuration file not reloaded after changes

**Solution**:
```json
"Accept": "application/json, text/event-stream"
```

### Configuration Not Taking Effect

1. **Check file location**: Ensure `.mcp.json` is in the correct directory
2. **Validate JSON syntax**: Use `cat .mcp.json | jq .` to check for errors
3. **Restart Claude Code**: Changes require a restart to take effect

### Still Getting Errors

Check server logs or contact support with:
- Your `.mcp.json` configuration (redact API key)
- The exact error message
- The curl command you used for testing

## Environment-Specific Notes

### Staging Environment

```json
{
  "mcpServers": {
    "kotadb-staging": {
      "type": "http",
      "url": "https://kotadb-staging.fly.dev/mcp",
      "headers": {
        "Authorization": "Bearer YOUR_STAGING_API_KEY",
        "Accept": "application/json, text/event-stream",
        "MCP-Protocol-Version": "2025-06-18"
      }
    }
  }
}
```

### Local Development

```json
{
  "mcpServers": {
    "kotadb-local": {
      "type": "http",
      "url": "http://localhost:3000/mcp",
      "headers": {
        "Authorization": "Bearer YOUR_LOCAL_API_KEY",
        "Accept": "application/json, text/event-stream",
        "MCP-Protocol-Version": "2025-06-18"
      }
    }
  }
}
```

## Additional Resources

- [MCP Claude Code Integration Guide](../guides/mcp-claude-code-integration.md)
- [CHANGELOG](../../CHANGELOG.md)
- [Issue #465](https://github.com/your-org/kota-db-ts/issues/465)

---

**Last Updated**: 2025-12-05
**Applies To**: v0.1.0 â†’ v0.1.1
