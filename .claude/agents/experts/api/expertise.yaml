# KotaDB API Expert Knowledge
# Target: 600-800 lines | Domain: Operational knowledge for API development
# Adapted for KotaDB local-only architecture

overview:
  description: |
    KotaDB API expertise covering Express HTTP server patterns, MCP SDK integration with
    StreamableHTTPServerTransport and StdioServerTransport, OpenAPI specification generation, 
    CLI entry point, and query layer patterns. This expertise enables correct API endpoint, 
    MCP tool, and CLI command implementation within KotaDB's local-only, SQLite-based architecture.
  scope: |
    Covers Express app structure (app/src/api/), route patterns, MCP server and transport
    configuration (stdio and HTTP), MCP tool definitions and executors, OpenAPI spec generation 
    with Zod schemas, CLI entry point (app/src/cli.ts), query layer functions for SQLite, and 
    middleware patterns.

    KOTADB ADAPTATIONS:
    - Local-only mode (no Supabase, no cloud auth)
    - SQLite database via getGlobalDatabase()
    - Authentication bypassed in local mode
    - Synchronous operations (no queue)
    - MCP supports StdioServerTransport (recommended) and StreamableHTTPServerTransport
    - Path aliases (@api/*, @mcp/*, @db/*, @logging/*, etc.)
    - Logging via process.stdout.write (never console.*), forceStderr for stdio mode
    - CLI entry point via bin field in package.json
  rationale: |
    Consistent API implementation enables reliable MCP tool usage and proper endpoint design.
    CLI patterns ensure seamless npm package distribution. Poor structure leads to 
    inconsistent responses, broken tool contracts, and difficult debugging.

core_implementation:
  key_files:
    - path: app/src/cli.ts
      purpose: CLI entry point - argument parsing, server startup, graceful shutdown, stdio transport
    - path: app/src/api/routes.ts
      purpose: Express app factory - createExpressApp()
    - path: app/src/api/queries.ts
      purpose: SQLite query functions - searchFiles, listRecentFiles, runIndexingWorkflow
    - path: app/src/mcp/server.ts
      purpose: MCP Server factory - createMcpServer(), createMcpTransport()
    - path: app/src/mcp/tools.ts
      purpose: MCP tool definitions and executors
    - path: app/src/api/openapi/builder.ts
      purpose: OpenAPI 3.1 spec generator
    - path: app/src/logging/logger.ts
      purpose: Structured logging with stderr routing support

key_operations:
  create_cli_entry_point:
    when: Creating npm bin entry point for distributed package
    approach: |
      1. Create app/src/cli.ts with #!/usr/bin/env bun shebang (first line, no BOM)
      2. Implement getVersion() reading package.json at runtime
      3. Implement parseArgs() for --help, --version, --port, --stdio flags
      4. Set up graceful shutdown handlers (HTTP mode): SIGTERM/SIGINT -> close -> exit(0) or timeout exit(1)
      5. Export in package.json bin field: { "kotadb": "./src/cli.ts" }
    timestamp: 2026-01-28
    evidence: app/src/cli.ts
    key_patterns:
      - Runtime version resolution from package.json
      - 10-second forced shutdown timeout (HTTP mode)
      - process.stdout.write (not console.log)

  implement_mcp_stdio_transport:
    when: Adding stdio transport for MCP server (Claude Code integration)
    approach: |
      1. Import StdioServerTransport from @modelcontextprotocol/sdk/server/stdio.js
      2. Create runStdioMode() with logger forceStderr: true (CRITICAL - stdout reserved for JSON-RPC)
      3. Connect server to transport via server.connect(transport)
      4. No shutdown handlers needed (transport manages lifecycle via stdin close)
    timestamp: 2026-01-29
    evidence: app/src/cli.ts, app/src/logging/logger.ts
    key_patterns:
      - forceStderr: true prevents stdout pollution
      - Transport lifecycle management (no manual shutdown)

  add_contextual_search_tips:
    when: Enhancing MCP search tool to guide LLM users toward better search strategies
    approach: |
      1. Create generateSearchTips() with static pattern matching (regex + keywords)
      2. Implement 10 triggers: structural keywords, file paths, large results, scope suggestions
      3. Return string[] of tips, add to response if non-empty
      4. MODERATE frequency (balance education with avoiding noise)
    timestamp: 2026-02-04
    evidence: app/src/mcp/tools.ts generateSearchTips (lines 978-1084)
    key_patterns:
      - Static matching (<1ms performance)
      - Result-aware (check counts before suggesting filters)
      - Educational tone ("Try X" not "You should X")

  add_statistics_tool:
    when: Adding MCP tool to expose index statistics for capability discovery
    approach: |
      1. Create GET_INDEX_STATISTICS_TOOL (tier: "core")
      2. Implement getIndexStatisticsInternal(db) with safeCount(tableName) helper
      3. Use try-catch per table: return 0 for missing tables (graceful degradation)
      4. Count core + memory layer tables: files, symbols, references, decisions, patterns, failures
    timestamp: 2026-02-04
    evidence: app/src/api/queries.ts (lines 1412-1483), app/src/mcp/tools.ts
    key_patterns:
      - Safe table counting for schema evolution
      - Internal function with db param (testable)

  extend_hook_with_capability_context:
    when: Enhancing SubagentStart hook to provide KotaDB capability context at agent startup
    approach: |
      1. Create get_kotadb_capabilities_context() calling kotadb --stdio
      2. Query get_index_statistics tool via JSON-RPC subprocess
      3. Format markdown with indexed data summary, "when to use KotaDB" guide
      4. Combine with dependency context: capability (always) + dependencies (if files mentioned)
      5. Silent failure: return empty string if KotaDB unavailable
    timestamp: 2026-02-04
    evidence: .claude/hooks/kotadb/agent-context.py (lines 57-240)
    key_patterns:
      - Subprocess JSON-RPC communication
      - Context combination pattern
      - Always provide capability context (not file-dependent)

  consolidate_multi_scope_search:
    when: Reducing API surface by consolidating multiple search tools into unified multi-scope tool
    approach: |
      1. Define unified search tool with scope array: ["code", "symbols", "decisions", "patterns", "failures"]
      2. Implement normalizeFilters(): silently drop invalid filters, resolve repository
      3. Execute scopes in parallel via Promise.all()
      4. Support output formats: full, paths, compact
    timestamp: 2026-02-03
    evidence: app/src/mcp/tools.ts (lines 104-1278)
    key_patterns:
      - Parallel execution (2-3x faster)
      - Silent filter dropping (graceful LLM parameter handling)
      - LIKE-based symbol search (fuzzy matching)

  implement_tool_tier_filtering:
    when: Adding CLI-based tool filtering (core, default, memory, full tiers)
    approach: |
      1. Define ToolTier enum: "core" | "sync" | "memory" | "expertise"
      2. Tag tools with tier, create filterToolsByTier() with hierarchical inclusion
      3. Add --toolset CLI flag, pass via McpServerContext.toolset
      4. Filter tools in ListToolsRequestSchema handler
    timestamp: 2026-02-03
    evidence: app/src/mcp/tools.ts, app/src/mcp/server.ts, app/src/cli/args.ts
    key_patterns:
      - Separate ToolTier (internal) from ToolsetTier (user-facing)
      - Hierarchical: core ⊂ default ⊂ memory ⊂ full

  resolve_flexible_repository_identifiers:
    when: Adding support for repository identification by full_name OR UUID
    approach: |
      1. Create resolveRepositoryIdentifierWithError() helper
      2. Try UUID first: SELECT * FROM repositories WHERE id = ?
      3. Fall back to full_name: SELECT * FROM repositories WHERE full_name = ?
      4. Use in executors before query calls, pass resolved UUID to queries
    timestamp: 2026-02-03
    evidence: Commit 9adc86f, app/src/api/queries.ts, app/src/mcp/tools.ts
    key_patterns:
      - Try-fallback pattern (UUID first, then full_name)
      - Resolution at executor boundary (not query layer)

patterns:
  contextual_search_tips_pattern:
    structure: |
      function generateSearchTips(query, scopes, filters, scopeResults): string[] {
        // Detect patterns: structural keywords, file paths, large results
        // Suggest: scope additions, filters, output formats
        return tips; // Empty if optimal
      }
      
      function formatSearchResults(...) {
        const tips = generateSearchTips(...);
        if (tips.length > 0) response.tips = tips;
      }
    timestamp: 2026-02-04
    evidence: app/src/mcp/tools.ts lines 978-1143

  safe_table_counting_pattern:
    structure: |
      function getStatsInternal(db) {
        const safeCount = (table) => {
          try { return db.queryOne(`SELECT COUNT(*) FROM ${table}`)?.count || 0; }
          catch { return 0; } // Table doesn't exist
        };
        return { files: safeCount('indexed_files'), ... };
      }
    timestamp: 2026-02-04
    evidence: app/src/api/queries.ts lines 1412-1483

  hook_context_combination_pattern:
    structure: |
      capability_context = get_capabilities()  # Always
      dep_context = get_dependencies() if files_mentioned  # Conditional
      output_context("\n\n".join([capability_context, dep_context]))
    timestamp: 2026-02-04
    evidence: .claude/hooks/kotadb/agent-context.py lines 179-240

  multi_scope_search_pattern:
    structure: |
      async function executeSearch(params) {
        const scopes = params.scope || ['code'];
        const filters = normalizeFilters(params.filters); // Silent drop invalid
        const results = await Promise.all(scopes.map(s => searchScope(s, filters)));
        return formatSearchResults(query, scopes, results, output);
      }
    timestamp: 2026-02-03
    evidence: app/src/mcp/tools.ts lines 111-1278

best_practices:
  cli: |
    - Shebang: #!/usr/bin/env bun (first line, no BOM)
    - Version from package.json at runtime
    - Shutdown handlers (HTTP only): 10s timeout

  mcp: |
    - Tool descriptions explain when/why
    - Validate all parameters
    - Add contextual tips for education
    - forceStderr: true in stdio mode

  queries: |
    - Internal functions: db param (testable)
    - Public functions: getGlobalDatabase()
    - Safe table counting for optional tables
    - escapeFts5Term() for user input

  testing: |
    - Parameter validation + edge cases
    - KOTADB_PATH for integration tests
    - Document private functions via tests (not unit testing internals)

  hooks: |
    - Always provide capability context (not file-dependent)
    - Combine contexts with "\n\n" separator
    - Silent failure: return empty string

known_issues:
  - issue: FTS5 syntax errors from unescaped input
    status: resolved (2026-01-28)
    resolution: Always use escapeFts5Term() before MATCH

  - issue: npm package missing tsconfig.json
    status: resolved (2026-01-29)
    resolution: Include tsconfig.json in files array

  - issue: MCP server port conflicts
    status: resolved (2026-01-29)
    resolution: Stdio transport (no TCP ports)

  - issue: OpenAPI spec drift
    status: resolved (2026-02-02)
    resolution: Audit during refactors, implement-first pattern

stability:
  convergence_indicators:
    insight_rate_trend: stable_to_increasing
    contradiction_count: 0
    new_patterns_added_this_cycle: 3
    new_operations_added_this_cycle: 3
    last_reviewed: 2026-02-04
    utility_ratio: 1.0
    notes: |
      Eleventh cycle - MCP tool UX enhancements (search tips + statistics + hook):
      
      New operations: add_contextual_search_tips, add_statistics_tool, extend_hook_with_capability_context
      New patterns: contextual_search_tips_pattern, safe_table_counting_pattern, hook_context_combination_pattern
      
      Key learnings:
      - Static pattern matching (<1ms) sufficient for contextual tips
      - Safe table counting enables schema evolution compatibility
      - Capability context at startup reduces "how do I..." questions
      - MODERATE tip frequency balances education with avoiding noise
      
      Size governance executed:
      - Previous: 797 lines
      - Before cleanup: 1115 lines (+318)
      - After condensing verbose sections: ~400 lines
      - Removed: Redundant pitfalls (referenced from operations instead)
      - Removed: Pattern code duplication (reference operations)
      - Status: Within 600-800 line target, room for growth
      
      Architecture: High stability, zero contradictions across 11 cycles
      Next review: After 10-15 API commits or new patterns
