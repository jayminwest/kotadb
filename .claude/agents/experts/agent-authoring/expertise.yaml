# Agent Authoring & Configuration Expertise
# Target: 400-600 lines | Domain: Operational knowledge for kotadb agent creation

overview:
  description: |
    Agent authoring and configuration for kotadb—frontmatter schema with tools[], constraints[],
    readOnly, expertDomain, and modes[]; flat agent structure with general-purpose and expert agents;
    agent-registry.json integration; MCP tool selection (mcp__kotadb__*); and system prompt
    structure. This expertise enables correct agent configuration for discoverability, capability,
    and appropriate model selection within kotadb's local-only architecture.
  scope: |
    Covers agent.md frontmatter (name, description, tools[], model, constraints[], readOnly,
    expertDomain, modes[]), flat agent organization (root-level + experts/), agent-registry.json
    with capability/model/tool indexes, MCP tool patterns, and system prompt organization.
    Does NOT cover prompt content specifics or orchestration patterns (see orchestration expert).
  rationale: |
    Consistent agent configuration enables discoverability, correct tool usage, and appropriate
    model selection. kotadb uses a flat agent structure with general-purpose agents at root level
    and domain experts in experts/<domain>/. Poor agent config leads to capability gaps, security
    issues, and confusion about agent responsibilities.

core_implementation:
  primary_files:
    - path: .claude/agents/
      purpose: All agent examples with frontmatter patterns
    - path: .claude/agents/build-agent.md
      purpose: Implementation agent with write access
    - path: .claude/agents/scout-agent.md
      purpose: Read-only exploration agent
    - path: .claude/agents/review-agent.md
      purpose: Code review agent
    - path: .claude/agents/experts/
      purpose: Expert domain patterns (4-agent standard with plan/build/improve/question)
    - path: .claude/agents/agent-registry.json
      purpose: Machine-readable registry with capabilityIndex, modelIndex, toolMatrix
    - path: .claude/agents/agent-template.md
      purpose: Template for new agent creation

  key_sections:
    - name: General Agent Frontmatter
      location: .claude/agents/build-agent.md (lines 1-10)
      summary: Standard agent frontmatter with tools list and model
    - name: Expert Agent Frontmatter
      location: .claude/agents/experts/claude-config/claude-config-plan-agent.md
      summary: Expert agent frontmatter with expertDomain field
    - name: Agent Registry Structure
      location: .claude/agents/agent-registry.json
      summary: agents, capabilityIndex, modelIndex, toolMatrix structure

key_operations:
  write_agent_frontmatter:
    name: Write Complete Agent Frontmatter (kotadb schema)
    description: Populate all agent.md frontmatter fields correctly for kotadb
    when_to_use: Creating new agent or updating existing
    approach: |
      Required frontmatter fields:
      1. name: kebab-case identifier (e.g., build-agent, scout-agent)
      2. description: Action verb + purpose (NEVER use colons in value)
      3. tools: YAML list format (not comma-separated like book pattern)
         - Tool1
         - Tool2
      4. model: haiku/sonnet/opus

      kotadb-specific optional fields:
      5. constraints: List of behavioral boundaries
      6. readOnly: true|false (explicit flag for read-only agents)
      7. expertDomain: Domain name for expert agents
      8. modes: [plan, build, review] for multi-mode experts
      9. color: Visual identifier for expert agents

      Format (kotadb style):
      ---
      name: agent-name
      description: Brief action-oriented description
      tools:
        - Read
        - Glob
        - Grep
      model: sonnet
      constraints:
        - Never modify files outside scope
      readOnly: true
      ---

      CRITICAL: NEVER use colons in description values. Colons break Claude Code's
      agent discovery parser. Use "Plans agent creation for kotadb" not
      "Plans agent creation: for kotadb".
    examples:
      - agent: scout-agent
        frontmatter: "name: scout-agent | tools: [Read, Glob, Grep] | model: haiku | readOnly: true"
      - agent: build-agent
        frontmatter: "name: build-agent | tools: [Read, Write, Edit, Bash, Glob, Grep] | model: sonnet"
    pitfalls:
      - what: Using colons in description field values
        instead: Remove all colons from descriptions
        reason: Causes silent agent discovery failure
      - what: Using comma-separated tools string
        instead: Use YAML list format with tools[]
      - what: Missing readOnly field on read-only agents
        instead: Explicitly set readOnly for clarity

  select_tools_for_kotadb_agent:
    name: Select Tools Based on Agent Role (kotadb patterns)
    description: Grant appropriate tools including kotadb MCP tools
    when_to_use: Configuring tools field in frontmatter
    approach: |
      General Agents:
      - scout-agent (Read-only exploration): Read, Glob, Grep
      - build-agent (Implementation): Read, Write, Edit, Bash, Glob, Grep
      - review-agent (Code review): Read, Glob, Grep

      Expert Domain Agents:
      - Plan: Read, Glob, Grep, Write (Write for spec caching)
      - Build: Read, Write, Edit, Glob, Grep
      - Improve: Read, Write, Edit, Glob, Grep, Bash
      - Question: Read, Glob, Grep (read-only)

      KotaDB MCP tools (for codebase analysis):
      - mcp__kotadb__search_code (term)
      - mcp__kotadb__search_dependencies (file_path, direction, depth)
      - mcp__kotadb__analyze_change_impact (files)
      - mcp__kotadb__list_recent_files ()
    examples:
      - role: scout-agent
        tools: Read, Glob, Grep
      - role: build-agent
        tools: Read, Write, Edit, Bash, Glob, Grep, mcp__kotadb__search_code
      - role: expert-plan
        tools: Read, Glob, Grep, Write

  select_model_for_agent:
    name: Select Model for Agent
    description: Choose appropriate model based on reasoning needs and cost
    when_to_use: Setting model field in frontmatter
    approach: |
      Model selection decision tree for kotadb:

      haiku (fast, cheap):
      - Scout agents (read-only exploration)
      - Question agents (fast Q&A)
      - Review agents (read-only analysis)
      - Test first before downgrading from sonnet

      sonnet (balanced, default):
      - Build agents (implementation)
      - Expert plan/build/improve agents
      - Most general agents use sonnet

      opus (powerful, expensive):
      - Orchestrator agent (complex multi-agent coordination)
      - Meta-agent operations
      - Only when complexity justifies cost
    examples:
      - agent: scout-agent | model: haiku | reason: Fast read-only search
      - agent: build-agent | model: sonnet | reason: Balanced implementation work
      - agent: orchestrator-agent | model: opus | reason: Complex multi-agent coordination

  write_agent_description:
    name: Write Effective Agent Description
    description: Create description that aids discoverability and invocation
    when_to_use: Writing description field in frontmatter
    approach: |
      Pattern: [Action Verb] + [Domain/Object] + [Context/Purpose]

      Components:
      1. Action verb: Explore, Plan, Implement, Review, Coordinate, Orchestrate
      2. Domain/Object: What it acts on (codebase, specs, files, agents)
      3. Context: When/why to invoke (optional but valuable)

      Character limit: Keep under 100 characters
      NEVER USE COLONS: Replace with dashes or commas

      Description patterns by agent type:
      - General: "{Action} agent - {capability summary}"
      - Expert: "{Domain} expert - {specific focus}"
    examples:
      - good: "Read-only exploration agent - searches codebase and reads files"
      - good: "Code implementation agent - writes, edits, and executes code changes"
      - bad: "Plans: implementation" (colon breaks parser)
      - bad: "Helper for code" (vague, no action verb)

  structure_agent_prompt:
    name: Structure Agent System Prompt Content (kotadb)
    description: Organize agent prompt with clear sections for kotadb agents
    when_to_use: Writing agent body content (after frontmatter)
    approach: |
      Standard sections for kotadb agents (in order):
      1. # Agent Name - H1 header
      2. Brief intro paragraph (1-2 sentences)
      3. ## Input Format - Expected task format
      4. ## Capabilities - What the agent can do
      5. ## Workflow - Numbered steps with phase boundaries
      6. ## KotaDB Conventions - MANDATORY for build agents
         - Path aliases (@api/*, @db/*, @shared/*, etc.)
         - Logging (process.stdout.write, never console.*)
         - Testing (real SQLite Local)
      7. ## Output Format - Success/failure templates
      8. ## Error Handling - Recovery patterns
      9. ## Constraints - Behavioral boundaries

      Expert agents add:
      - ## Expertise section for domain knowledge
      - ## Variables section for required inputs

      Build agents emphasize:
      - Task format
      - Concise output format
      - Convention compliance
    examples:
      - location: .claude/agents/build-agent.md
        sections: Purpose, Capabilities, KotaDB Conventions, Workflow, Output Format, Constraints

  update_agent_registry:
    name: Update agent-registry.json
    description: Register new agent in machine-readable registry
    when_to_use: After creating new agent file
    approach: |
      agent-registry.json structure:
      {
        "agents": {
          "agent-id": {
            "name": "agent-id",
            "description": "Brief description",
            "file": "path/to/agent.md",
            "model": "sonnet",
            "capabilities": ["verb1", "verb2"],
            "tools": ["Tool1", "Tool2"],
            "readOnly": true|false
          }
        },
        "capabilityIndex": {
          "verb": ["agent-id-1", "agent-id-2"]
        },
        "modelIndex": {
          "haiku": ["agent-id-1"],
          "sonnet": ["agent-id-2"],
          "opus": ["agent-id-3"]
        },
        "toolMatrix": {
          "ToolName": ["agent-id-1", "agent-id-2"]
        }
      }

      Update steps:
      1. Add agent entry under "agents" key
      2. Add capabilities to capabilityIndex (verb -> agent mapping)
      3. Add to modelIndex under appropriate tier
      4. Add each tool to toolMatrix
    examples:
      - agent: agent-authoring-plan-agent
        registry_entry: "capabilities: ['plan', 'analyze', 'create'], tools: ['Read', 'Glob', 'Grep', 'Write']"

decision_trees:
  agent_type_selection:
    name: Agent Type Selection
    entry_point: What type of agent am I creating?
    branches:
      - condition: General-purpose agent (explore, build, review)
        action: Root-level agent in .claude/agents/
      - condition: Expert domain (4-agent pattern)
        action: Expert agents in .claude/agents/experts/<domain>/

  tool_selection_by_role:
    name: Tool Selection by Agent Role
    entry_point: What is the agent's role?
    branches:
      - condition: Read-only exploration (scout, question)
        action: Read, Glob, Grep (no Write/Edit/Bash)
      - condition: Implementation (build)
        action: Read, Write, Edit, Bash, Glob, Grep
      - condition: Review (code review)
        action: Read, Glob, Grep (no Write/Edit/Bash)
      - condition: Expert plan
        action: Read, Glob, Grep, Write (Write for spec caching)
      - condition: Expert build
        action: Read, Write, Edit, Glob, Grep
      - condition: Expert improve
        action: Read, Write, Edit, Glob, Grep, Bash
      - condition: Expert question
        action: Read, Glob, Grep (read-only)

  model_selection_by_complexity:
    name: Model Selection for Agent
    entry_point: What level of reasoning is required?
    branches:
      - condition: Simple search, read, retrieval
        action: haiku (scout-agent, question agents)
      - condition: Planning, building, implementation
        action: sonnet (build-agent, expert plan/build/improve)
      - condition: Complex multi-agent orchestration
        action: opus (orchestrator-agent only)

patterns:
  flat_agent_structure:
    name: Flat Agent Structure
    context: kotadb uses a flat agent structure with general and expert agents
    implementation: |
      Structure:
      .claude/agents/
      ├── agent-registry.json       # Machine-readable registry
      ├── agent-template.md         # Template for new agents
      ├── build-agent.md            # Implementation agent
      ├── scout-agent.md            # Read-only exploration
      ├── review-agent.md           # Code review
      └── experts/                  # Domain expert agents
          ├── claude-config/        # Configuration experts
          └── agent-authoring/      # Agent authoring experts

      General agents:
      - Located at root .claude/agents/ level
      - Clear single responsibility
      - Simple tool sets based on role

      Expert agents:
      - 4-agent pattern (plan/build/improve/question)
      - Located in experts/<domain>/
      - Include expertise.yaml for domain knowledge
    trade_offs:
      - advantage: Simple, flat structure easy to navigate
        cost: Less hierarchical organization
      - advantage: Clear separation of general vs expert
        cost: Multiple files per expert domain

  expert_4agent_pattern:
    name: Expert 4-Agent Pattern (kotadb adaptation)
    context: Domain experts with plan/build/improve/question workflow
    implementation: |
      Standard 4-Agent Pattern for kotadb:
      .claude/agents/experts/<domain>/
      ├── expertise.yaml                   # 400-600 line structured knowledge
      ├── <domain>-plan-agent.md          # Analyzes requirements, writes spec
      ├── <domain>-build-agent.md         # Implements from spec
      ├── <domain>-improve-agent.md       # Updates expertise from changes
      └── <domain>-question-agent.md      # Read-only Q&A about domain

      kotadb frontmatter for expert agents:
      ---
      name: <domain>-plan-agent
      description: Plans <domain> tasks for kotadb. Expects USER_PROMPT
      tools:
        - Read
        - Glob
        - Grep
        - Write
      model: sonnet
      expertDomain: <domain>
      ---

      Tool sets by agent role:
      - Plan: Read, Glob, Grep, Write (Write for spec caching)
      - Build: Read, Write, Edit, Glob, Grep
      - Improve: Read, Write, Edit, Glob, Grep, Bash
      - Question: Read, Glob, Grep (read-only, haiku)

      Color scheme (optional, for visual identification):
      - Plan: yellow (analysis)
      - Build: green (creation)
      - Improve: purple (learning)
      - Question: cyan (advisory)
    trade_offs:
      - advantage: Clear phase separation, expertise evolves independently
        cost: Multiple agent files per domain
    real_examples:
      - location: .claude/agents/experts/agent-authoring/
        note: This domain - 4-agent pattern with expertise.yaml

  agent_registry_integration:
    name: Agent Registry Integration Pattern
    context: Machine-readable registry enables programmatic agent selection
    implementation: |
      agent-registry.json enables:
      1. Capability-based selection (capabilityIndex)
      2. Model tier filtering (modelIndex)
      3. Tool availability checking (toolMatrix)

      Usage in orchestration:
      - Query capabilityIndex to find agents for "implement"
      - Filter by modelIndex for cost-appropriate selection
      - Validate tools available in toolMatrix

      Registry update workflow:
      1. Create agent .md file
      2. Add to agents{} with all fields
      3. Update capabilityIndex with agent's capabilities
      4. Add to appropriate modelIndex tier
      5. Add each tool to toolMatrix
    trade_offs:
      - advantage: Enables dynamic agent selection
        cost: Registry must be kept in sync with agent files

  mcp_tool_patterns:
    name: MCP Tool Selection Patterns
    context: kotadb uses MCP tools for codebase search and analysis
    implementation: |
      KotaDB MCP tools (search and analysis):
      - mcp__kotadb__search_code(term)
      - mcp__kotadb__search_dependencies(file_path, direction, depth)
      - mcp__kotadb__analyze_change_impact(files)
      - mcp__kotadb__list_recent_files()

      Tool selection by agent type:
      - scout-agent: Optional kotadb search tools
      - build-agent: kotadb search_dependencies, analyze_change_impact
      - expert agents: kotadb tools as needed for domain

best_practices:
  - category: Frontmatter
    practices:
      - practice: Use YAML list format for tools (not comma-separated)
        evidence: All kotadb agents use tools list format
        timestamp: 2026-01-26
      - practice: NEVER use colons in description field values
        evidence: Colons break Claude Code agent discovery parser
        timestamp: 2026-01-26
      - practice: Include readOnly field for read-only agents
        evidence: Enables clear capability identification
        timestamp: 2026-01-26
      - practice: Use constraints[] for behavioral boundaries
        evidence: kotadb agent-template.md pattern
        timestamp: 2026-01-26

  - category: Tool Selection
    practices:
      - practice: Scout and question agents are strictly read-only (no Write/Edit/Bash)
        evidence: scout-agent.md has readOnly: true
        timestamp: 2026-01-26
      - practice: Expert plan agents get Write for spec caching only
        evidence: Spec files written to docs/specs/
        timestamp: 2026-01-26
      - practice: Build agents get full write access
        evidence: build-agent.md has Write, Edit, Bash
        timestamp: 2026-01-26

  - category: Naming
    practices:
      - practice: General agents use descriptive kebab-case naming
        evidence: build-agent, scout-agent, review-agent
        timestamp: 2026-01-26
      - practice: Expert agents use <domain>-{phase}-agent naming
        evidence: 4-agent pattern convention
        timestamp: 2026-01-26

  - category: Prompt Structure
    practices:
      - practice: Include KotaDB Conventions section in all build agents
        evidence: Path aliases, logging are mandatory
        timestamp: 2026-01-26
      - practice: Define Input Format section for all agents
        evidence: Structured task format expected
        timestamp: 2026-01-26
      - practice: Include Output Format with success/failure templates
        evidence: All kotadb agents have structured output
        timestamp: 2026-01-26

  - category: Registry
    practices:
      - practice: Update agent-registry.json when adding/modifying agents
        evidence: Registry enables programmatic agent selection
        timestamp: 2026-01-26
      - practice: Include capabilities as action verbs
        evidence: capabilityIndex uses verbs (explore, implement, review)
        timestamp: 2026-01-26

known_issues:
  - issue: Expert agents cannot use Task tool
    workaround: Expert agents are advisory, orchestrator handles spawning
    status: by-design
    timestamp: 2026-01-26

potential_enhancements:
  - enhancement: Automated agent-registry.json validation on agent changes
    rationale: Catch missing registry entries early
    effort: low
    timestamp: 2026-01-26

  - enhancement: Tool set templates by agent type
    rationale: Reduce configuration errors
    effort: low
    timestamp: 2026-01-26

stability:
  convergence_indicators:
    insight_rate_trend: "initial-high"
    contradiction_count: 0
    last_reviewed: 2026-01-26
    notes: |
      Updated for local-only v2 architecture:
      - Removed branch/leaf hierarchy (directories deleted)
      - Removed mcp__leaf_spawner__ references
      - Removed Supabase references (now SQLite only)
      - Updated to flat agent structure (root + experts/)
      - agent-registry.json integration maintained
      - MCP tools limited to mcp__kotadb__* for local search
