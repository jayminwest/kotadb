#!/usr/bin/env sh

# Pre-commit hook for KotaDB
# Runs type-check and lint on changed app/ and shared/ files

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if any files in app/ or shared/ were changed
APP_CHANGED=$(echo "$STAGED_FILES" | grep "^app/" || true)
SHARED_CHANGED=$(echo "$STAGED_FILES" | grep "^shared/" || true)

# Exit early if no relevant files changed
if [ -z "$APP_CHANGED" ] && [ -z "$SHARED_CHANGED" ]; then
  echo "‚úÖ No app/ or shared/ files changed, skipping checks"
  exit 0
fi

echo "üîç Running pre-commit checks..."

# Type-check shared/ if changed
if [ -n "$SHARED_CHANGED" ]; then
  echo "üì¶ Type-checking shared/..."
  cd shared && bunx tsc --noEmit
  if [ $? -ne 0 ]; then
    echo "‚ùå Type-check failed in shared/"
    exit 1
  fi
  cd ..
fi

# Type-check and lint app/ if changed
if [ -n "$APP_CHANGED" ]; then
  echo "üì¶ Type-checking app/..."
  cd app && bunx tsc --noEmit
  if [ $? -ne 0 ]; then
    echo "‚ùå Type-check failed in app/"
    exit 1
  fi

  echo "üßπ Linting app/..."
  bun run lint
  if [ $? -ne 0 ]; then
    echo "‚ùå Lint failed in app/"
    exit 1
  fi
  cd ..
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
